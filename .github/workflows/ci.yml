name: NovelTea CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
    
    - name: Checkout
      uses: actions/checkout@v2
      
    - name: Cache Qt and SFML
      id: cache
      uses: actions/cache@v2
      with:
        path: |
          ../Qt
          SFML/install
        key: ${{ runner.os }}-NovelTea
          
    - name: Setup Linux Environment
      if: ${{ runner.os == 'Linux' }}
      continue-on-error: true
      run: |
        sudo apt install libxrandr-dev libudev-dev libopenal-dev libflac-dev libvorbis-dev libgl1-mesa-dev
        sudo apt install doxygen libgtest-dev
        
    - name: Install Qt
      uses: jurplel/install-qt-action@v2
      with:
        cached: ${{ steps.cache.outputs.cache-hit }}

    - name: Checkout SFML
      if: ${{ !steps.cache.outputs.cache-hit }}
      uses: actions/checkout@v2
      with:
        repository: SFML/SFML
        path: SFML

    - name: Compile SFML
      if: ${{ !steps.cache.outputs.cache-hit }}
      run: |
        cd SFML
        mkdir install
        mkdir build
        cd build
        cmake -DCMAKE_INSTALL_PREFIX=../install -DCMAKE_INSTALL_FRAMEWORK_PREFIX=../install -DSFML_BUILD_FRAMEWORKS=FALSE -DBUILD_SHARED_LIBS=TRUE ..
        cmake --build . --config Release --target install
        cd ../..
        
    - name: Compile NovelTea
      run: |
        mkdir -p install/NovelTea
        mkdir -p doc/github.io/docs
        cmake -DBUILD_TEST=OFF -DCMAKE_INSTALL_PREFIX=./install/NovelTea -DSFML_DIR=./SFML/install/lib/cmake/SFML .
        cmake --build . --config Release --target install

  release:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
    - name: Test
      run: |
        echo hi
